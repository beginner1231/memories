
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>日志</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="" />
<meta name="keywords" content="" />
<link rel="stylesheet" type="text/css" href="css/animate.css">
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/jquery.range.css">
<link rel="stylesheet" type="text/css" href="css/line-awesome.css">
<link rel="stylesheet" type="text/css"
	href="css/line-awesome-font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="lib/slick/slick.css">
<link rel="stylesheet" type="text/css" href="lib/slick/slick-theme.css">
<link rel="stylesheet" type="text/css" href="css/style.css">
<link rel="stylesheet" type="text/css" href="css/responsive.css">
<link rel="stylesheet" href="../layui/css/layui.css">

</head>


<body>


	<div class="wrapper">





		<main>
		<div class="main-section">
			<div class="container">
				<div class="main-section-data">
					<div class="row">
						<div class="col-lg-3">
							<div class="filter-secs">
								<div class="filter-heading">

									<button type="button" class="layui-btn layui-btn-normal">写日志</button>
								</div>
								<!--filter-heading end-->
								<div class="paddy">
									<div class="filter-dd">
										<div class="filter-ttl">
											<h3>搜索日志</h3>
										</div>
										<form>
											<input type="text" name="search-skills" placeholder="请输入关键字">
										</form>
									</div>


									<div class="filter-dd">
										<div class="filter-ttl">
											<h3>日志发布时间</h3>

										</div>
										<form class="job-tp">
											<select>
												<option>选择时间</option>
												<option>一周内</option>
												<option>一个月内</option>
												<option>一年内</option>
												<option>一年以前</option>
											</select> <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
										</form>
									</div>
									<div class="filter-dd">
										<div class="filter-ttl">
											<h3>日志标签</h3>
											<a href="#" title="">Clear</a>
										</div>
										<form class="job-tp">
											<select>
												<option>选择标签</option>
												<option>日记</option>
												<option>游记</option>
												<option>....</option>
											</select> <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
										</form>
									</div>
								</div>
							</div>
							<!--filter-secs end-->
						</div>
						<div class="col-lg-6">
							<div class="main-ws-sec">

								<div class="post-bar" id="div1">
									<br/>
									<div class="input-group-btn">
										
										<button type="button" class="btn layui-btn btn-delete">删除</button>
										
									</div>


									<table class="layui-table">
										<colgroup>
											<col width="80">
											<col width="200">
											<col>
										</colgroup>
										<thead>
											<tr>
												<th><input type="checkbox" id="checkAll">全选</th>
												<th>标题</th>
												<th>创建时间</th>
												<th>标签</th>
											</tr>
										</thead>
										<tbody id="tbodyId">


										</tbody>
									</table>
								</div>
								<!--process-comm end-->
								<div class="post-bar" id="pageId"></div>
								<div class="posts-section">
									<div class="post-bar">
										<div id="editor1"></div>
									</div>
								</div>
								
								<!--post-bar end-->

							</div>
							<!--posts-section end-->
						</div>
						<!--main-ws-sec end-->
					</div>

				</div>
			</div>
			<!-- main-section-data end-->
		</div>
	</div>
	</main>


	</div>
	<!--theme-layout end-->



	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/popper.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.range-min.js"></script>
	<script type="text/javascript" src="lib/slick/slick.min.js"></script>
	<script type="text/javascript" src="js/script.js"></script>
	<script type="text/javascript" src="./layui/layui.js"></script>
	
		
	
	<script type="text/javascript">
$(function() {
	//异步加载分页页面
	//当load函数异步请求结束执行doGetObjects
	$("#pageId").load("doPageUI", doGetObjects);
	//搜索按钮事件注册
	//$(".input-group-btn").on("click",".btn-search",doQueryObjects);
	//删除按钮事件注册
	$(".input-group-btn").on("click",".btn-delete",doDeleteObjects);
	//thead中checkbox对象事件注册
	$("#checkAll").change(doChangeTBodyCheckBoxState);
	//tbody中checkbox对象事件注册
	$("#tbodyId").on("change",".cBox",doChangeTHeadCheckBoxState);
	
	$(".filter-heading").on("click",".layui-btn-normal",doGetEditor);
});

function doGetObjects() {
	//初始化thead中checkbox对象的状态
	$("#checkAll").prop("checked",false)
	//debugger;//断点调试
	//1.定义url和参数
	var url = "journal/doFindPageObjects";
	var pageCurrent=$("#pageId").data("pageCurrent");
	if(!pageCurrent){
		pageCurrent=1;
	}
	var params = {"pageCurrent" : pageCurrent};//pageCurrent=2
	//2.发起异步请求
	//请问如下ajax请求的回调函数参数名可以是任意吗？可以,必须符合标识符的规范
	$.getJSON(url, params, function(result) {
		//JsonResult->PageObject->List<SysLogs>+...
		//请问result是一个字符串还是json格式的js对象？对象
		doHandleResponseResult(result);
	});//特殊的ajax函数
}

function doHandleResponseResult(result){
	if(result.state==1){
		//1.将日志记录添加的tbody中
		doSetTableBodyRows(result.data.records)
		//2.将日志分页信息添加到pageId位置
		doSetPagination(result.data)
	}else{
		alert(result.message);
	}
}

function doSetTableBodyRows(records){
	//1.获取tbody对象,并清空数据
	var tBody = $("#tbodyId");
	tBody.empty();
	//2.迭代日志记录records,并将其追加到tbody
	for(var i=0;i<records.length;i++){
		//2.1 创建tr对象
		var tr = $("<tr></tr>");
		//2.2 创建多个td对象
		var tds = doCreateTds(records[i],i);
		//2.3 将td追加到tr对象
		tr.append(tds);
		//2.4 将tr追加到tbody中
		tBody.append(tr);
	}
}

function doCreateTds(data,i){
	var tds="<td><input type='checkbox' class='cBox' name='cItem"+i+"' value='"+data.id+"'></td>"+
		   	"<td onclick='showContent("+i+")'>"+data.title+"</td>"+
		    "<td>"+fttDate(data.createdTime)+"</td>"+
		    "<td>"+data.label+"</td>";
	return tds;
}

$(function(){
  $(".content").click(function(){
	  var url="journal/doEditorUI";
	  $(".editor").load(url);
  })
}) 

//点击删除按钮执行删除操作
	function doDeleteObjects(){
		//1.获取选中纪录的id并校验
		let idArray = doGetCheckedIds();
		if(idArray.length==0){
			alert("请先选中");
			return;
		}
		//2.提示是否删除
		if(!confirm("确认删除吗")){
			return
		}
		//3.定于删除的url
		var url = "journal/doDeleteObjects"
		//4.定义删除时要传递的参数
		var params = {"ids":idArray.toString()};
		//5.执行异步删除业务
		$.post(url,params,function(result){
			if(result.state==1){
				 alert(result.message);
				 //刷新策略(重新查询,清空tbody内容)
				 doRefrush();
			   }else{
				 alert(result.message);
			   }
		})
	}
	
//获取选中的id值
function doGetCheckedIds(){
	//1.定义数组,用于存储id
	let array=[];
	//2.遍历所有checkbox获得选中的id存数组
	$("#tbodyId input[type='checkbox']").each(function(){
		//假如此元素的checked属性的值为true
		if($(this).prop("checked")){
			//调用数组对象的push方法将选中对象的值存储到数组
			array.push($(this).val());
		}
	});
	return array;
}

function doRefrush(){
	//1.获取当前页码值,总页数
	var pageCurrent=$("#pageId").data("pageCurrent");
	var pageCount=$("#pageId").data("pageCount");
	//2.获取checkAll的状态值
	let flag = $("#checkAll").prop("checked");
	if(pageCurrent==pageCount&&pageCurrent==1&&flag){
		$("#checkAll").prop("checked",false);
		$("#tbodyId").empty();
		doInitPagination();
		return;
	}
	//3.修改当前页码值
	if(flag&&(pageCurrent==pageCount)&&(pageCurrent>1)){
		pageCurrent--;
		$("#pageId").data("pageCurrent",pageCurrent);
	}
	doGetObjects();
}

//全选或全不选
function doChangeTBodyCheckBoxState(){
	//1.获取全选对象的状态值
	let flag = $(this).prop("checked");
	//2.修改tbody中checkbox对象的状态值
	$("#tbodyId input[type='checkbox']").each(function(){
		$(this).prop("checked",flag);
	})
}

//反选
function doChangeTHeadCheckBoxState(){
	//1.设定默认状态值
	var flag=true;
	//2.迭代所有tbody中的checkbox值并进行与操作
	$("#tbodyId input[name='cItem']").each(function(){
		flag=flag&$(this).prop("checked")
	});
	//3.修改全选元素checkbox的值为flag
	$("#checkAll").prop("checked",flag);
}

function doGetEditor(){
	var url="/journal/doEditorUI";
	$("#editor1").load(url);
}

function fttDate(time) {
	//格式化时间成此格式 2019-06-23 10:20:03
	var dateee = new Date(time).toJSON();
	var date = new Date(+new Date(dateee) + 8 * 3600 * 1000).toISOString()
			.replace(/T/g, ' ').replace(/\.[\d]{3}Z/, '')
	return date;
}

function showContent(i) {
	var url="/journal/doEditorUI2";
	$("#editor1").load(url);
	 var id=doGetCheckedId(i);
	 console.log("id="+id);
	 findObjectById(id);
}

function doGetCheckedId(i){
	 return $("tbody input[name='cItem"+i+"']").val();
  }

function findObjectById(id){
	//1.params
	   var params={"id":id};
	   //2.url
	   var url="journal/doFindObjectById";
	   //3.ajax request
	   $.getJSON(url,params,function(result){//JsonResult
		   if(result.state==1){
			  $("#tbodyId").data("journal",result.data); 
	          doLoadPage();
		   }else{
			  alert(result.message);
		   }
	   });
}

function doLoadPage(){
	
	var journal = $("#tbodyId").data("journal"); 
	console.log(journal);
	$("#title").val(journal.title);
	$("#label").val(journal.label);
	editor.txt.html(journal.content);
}

</script>

</body>
</html>
